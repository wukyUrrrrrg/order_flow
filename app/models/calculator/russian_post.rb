# -*- coding: utf-8 -*-
class Calculator::RussianPost < Calculator

  ##########################################
  # Калькулятор стоимости доставки Почтой России
  ##########################################
  # 1) почтовый тариф (зависит от веса и расстояния, т.е. зоны)
  # 2) страховой сбор (обычно 4% от суммы оценки посылки)
  # 3) упаковка посылки 


  ##########################################
  # Инструкция для актуализации баз индексов
  ##########################################
  # 1) Скачать последнюю базу данных индексов и зон
  #    http://info.russianpost.ru/database/tzones.html
  #    Сейчас используется база от 05.07.2010 г.
  # 2) Используя, например, программу dbview экспортировать базу:
  #    dbview RZMsk11.DBF > indexes.txt
  # 3) Пользуясь простым скриптом получить массив INDEX_ZONE_HASH
  #    puts Hash[*File.read('indexes.txt').scan(/^Index      : (\d\d\d)\d\d\d\nRatezone   : (\d+)$/).flatten].inspect
  

  VES_TOVARA_PO_UMOLCHANIYU = 400  # Assume gramms
  STRAHOVOY_SBOR = 4 # percents
  # INDEX_ZONE_HASH = {"303"=>"1", "410"=>"2", "115"=>"1", "141"=>"1", "142"=>"1", "305"=>"1", "412"=>"2", "600"=>"1", "117"=>"1", "143"=>"1", "306"=>"1", "413"=>"2", "601"=>"1", "144"=>"1", "170"=>"1", "307"=>"1", "414"=>"2", "440"=>"2", "602"=>"1", "119"=>"1", "171"=>"1", "308"=>"2", "360"=>"2", "603"=>"1", "172"=>"1", "361"=>"2", "416"=>"2", "442"=>"2", "630"=>"3", "173"=>"2", "309"=>"2", "362"=>"2", "443"=>"2", "174"=>"2", "901"=>"1", "363"=>"2", "606"=>"1", "632"=>"3", "175"=>"2", "364"=>"2", "390"=>"1", "445"=>"2", "607"=>"1", "633"=>"3", "391"=>"1", "446"=>"2", "634"=>"3", "660"=>"3", "392"=>"1", "366"=>"2", "636"=>"3", "662"=>"3", "367"=>"3", "393"=>"1", "663"=>"3", "368"=>"3", "394"=>"1", "690"=>"5", "664"=>"4", "369"=>"2", "665"=>"4", "396"=>"1", "692"=>"5", "666"=>"4", "397"=>"1", "693"=>"5", "101"=>"1", "667"=>"3", "398"=>"1", "694"=>"5", "102"=>"1", "668"=>"3", "399"=>"1", "103"=>"1", "669"=>"4", "104"=>"1", "130"=>"1", "105"=>"1", "131"=>"1", "400"=>"2", "106"=>"1", "132"=>"1", "107"=>"1", "214"=>"1", "108"=>"1", "160"=>"1", "215"=>"1", "241"=>"1", "403"=>"2", "109"=>"1", "135"=>"1", "161"=>"1", "216"=>"1", "242"=>"1", "404"=>"2", "430"=>"2", "162"=>"1", "243"=>"1", "350"=>"2", "431"=>"2", "163"=>"2", "432"=>"2", "620"=>"2", "164"=>"2", "190"=>"2", "352"=>"2", "433"=>"2", "165"=>"2", "191"=>"2", "353"=>"2", "460"=>"2", "622"=>"2", "166"=>"2", "192"=>"2", "354"=>"2", "461"=>"2", "623"=>"2", "167"=>"2", "193"=>"2", "248"=>"1", "355"=>"2", "462"=>"2", "624"=>"2", "650"=>"3", "194"=>"2", "249"=>"1", "356"=>"2", "625"=>"3", "168"=>"2", "195"=>"2", "357"=>"2", "626"=>"3", "652"=>"3", "169"=>"2", "358"=>"2", "627"=>"3", "653"=>"3", "196"=>"2", "359"=>"2", "385"=>"2", "628"=>"3", "654"=>"3", "680"=>"5", "197"=>"2", "681"=>"5", "386"=>"2", "629"=>"3", "655"=>"3", "198"=>"2", "682"=>"5", "468"=>"5", "656"=>"3", "199"=>"2", "683"=>"5", "684"=>"5", "658"=>"3", "685"=>"5", "659"=>"3", "200"=>"2", "686"=>"5", "687"=>"4", "121"=>"1", "688"=>"5", "689"=>"5", "123"=>"1", "500"=>"0", "124"=>"1", "150"=>"1", "125"=>"1", "420"=>"2", "152"=>"1", "421"=>"2", "610"=>"2", "127"=>"1", "153"=>"1", "422"=>"2", "180"=>"2", "423"=>"2", "612"=>"2", "129"=>"1", "155"=>"1", "181"=>"2", "236"=>"2", "424"=>"2", "450"=>"2", "613"=>"2", "156"=>"1", "182"=>"2", "344"=>"2", "425"=>"2", "614"=>"2", "640"=>"3", "157"=>"1", "183"=>"2", "238"=>"2", "426"=>"2", "452"=>"2", "641"=>"3", "184"=>"2", "346"=>"2", "427"=>"2", "453"=>"2", "185"=>"2", "347"=>"2", "428"=>"2", "454"=>"2", "617"=>"2", "186"=>"2", "429"=>"2", "455"=>"2", "618"=>"2", "644"=>"3", "670"=>"4", "187"=>"2", "456"=>"2", "619"=>"2", "671"=>"4", "188"=>"2", "457"=>"2", "646"=>"3", "672"=>"4", "647"=>"3", "673"=>"4", "674"=>"4", "648"=>"3", "675"=>"4", "649"=>"3", "676"=>"4", "111"=>"1", "677"=>"4", "300"=>"1", "678"=>"4", "301"=>"1", "679"=>"5", "302"=>"1", "140"=>"1"}
  INDEX_ZONE_HASH = {"303"=>"1", "410"=>"2", "115"=>"1", "141"=>"1", "142"=>"1", "305"=>"1", "412"=>"2", "600"=>"1", "117"=>"1", "143"=>"1", "306"=>"1", "413"=>"2", "601"=>"1", "144"=>"1", "170"=>"1", "307"=>"1", "414"=>"2", "440"=>"2", "602"=>"1", "119"=>"1", "171"=>"1", "308"=>"2", "360"=>"2", "603"=>"1", "172"=>"1", "361"=>"2", "416"=>"2", "442"=>"2", "630"=>"3", "173"=>"2", "309"=>"2", "362"=>"2", "443"=>"2", "174"=>"2", "901"=>"1", "363"=>"2", "606"=>"1", "632"=>"3", "175"=>"2", "364"=>"2", "390"=>"1", "445"=>"2", "607"=>"1", "633"=>"3", "391"=>"1", "446"=>"2", "634"=>"3", "660"=>"3", "392"=>"1", "366"=>"2", "636"=>"3", "662"=>"3", "367"=>"3", "393"=>"1", "663"=>"3", "368"=>"3", "394"=>"1", "690"=>"5", "664"=>"4", "369"=>"2", "665"=>"4", "396"=>"1", "692"=>"5", "666"=>"4", "397"=>"1", "693"=>"5", "101"=>"1", "667"=>"3", "398"=>"1", "694"=>"5", "102"=>"1", "668"=>"3", "399"=>"1", "103"=>"1", "669"=>"4", "104"=>"1", "130"=>"1", "105"=>"1", "131"=>"1", "400"=>"2", "106"=>"1", "132"=>"1", "107"=>"1", "214"=>"1", "108"=>"1", "160"=>"1", "215"=>"1", "241"=>"1", "403"=>"2", "109"=>"1", "135"=>"1", "161"=>"1", "216"=>"1", "242"=>"1", "404"=>"2", "430"=>"2", "162"=>"1", "243"=>"1", "350"=>"2", "431"=>"2", "163"=>"2", "432"=>"2", "620"=>"2", "164"=>"2", "190"=>"2", "352"=>"2", "433"=>"2", "165"=>"2", "191"=>"2", "353"=>"2", "460"=>"2", "622"=>"2", "166"=>"2", "192"=>"2", "354"=>"2", "461"=>"2", "623"=>"2", "167"=>"2", "193"=>"2", "248"=>"1", "355"=>"2", "462"=>"2", "624"=>"2", "650"=>"3", "194"=>"2", "249"=>"1", "356"=>"2", "625"=>"3", "168"=>"2", "195"=>"2", "357"=>"2", "626"=>"3", "652"=>"3", "169"=>"2", "358"=>"2", "627"=>"3", "653"=>"3", "196"=>"2", "359"=>"2", "385"=>"2", "628"=>"3", "654"=>"3", "680"=>"5", "197"=>"2", "681"=>"5", "386"=>"2", "629"=>"3", "655"=>"3", "198"=>"2", "682"=>"5", "468"=>"5", "656"=>"3", "199"=>"2", "683"=>"5", "684"=>"5", "658"=>"3", "685"=>"5", "659"=>"3", "200"=>"2", "686"=>"5", "687"=>"4", "121"=>"1", "688"=>"5", "689"=>"5", "123"=>"1", "500"=>"0", "124"=>"1", "150"=>"1", "125"=>"1", "420"=>"2", "152"=>"1", "421"=>"2", "610"=>"2", "127"=>"1", "153"=>"1", "422"=>"2", "180"=>"2", "423"=>"2", "612"=>"2", "129"=>"1", "155"=>"1", "181"=>"2", "236"=>"2", "424"=>"2", "450"=>"2", "613"=>"2", "156"=>"1", "182"=>"2", "344"=>"2", "425"=>"2", "614"=>"2", "640"=>"3", "157"=>"1", "183"=>"2", "238"=>"2", "426"=>"2", "452"=>"2", "641"=>"3", "184"=>"2", "346"=>"2", "427"=>"2", "453"=>"2", "185"=>"2", "347"=>"2", "428"=>"2", "454"=>"2", "617"=>"2", "186"=>"2", "429"=>"2", "455"=>"2", "618"=>"2", "644"=>"3", "670"=>"4", "187"=>"2", "456"=>"2", "619"=>"2", "671"=>"4", "188"=>"2", "457"=>"2", "646"=>"3", "672"=>"4", "647"=>"3", "673"=>"4", "674"=>"4", "648"=>"3", "675"=>"4", "649"=>"3", "676"=>"4", "111"=>"1", "677"=>"4", "300"=>"1", "678"=>"4", "301"=>"1", "679"=>"5", "302"=>"1", "140"=>"1"}

  ##########################################
  # Инструкция для актуализации баз индексов труднодоступных районов
  ##########################################
  # 1) Скачать последнюю базу данных индексов и зон
  #    http://info.russianpost.ru/database/tzones.html
  #    Сейчас используется база от 05.07.2010 г.
  # 2) Используя, например, программу dbview экспортировать базу:
  #    dbview DlvLim20.DBF > indexes.txt
  # 3) Пользуясь простым скриптом получить массив TRUDNODOSTUPNIE_INDEXI
  #    File.read('indexes.txt').scan(/^Index      : (\d{6})\n/).flatten.collect{|i| i.to_i}
  # 
  TRUDNODOSTUPNIE_INDEXI = [157164, 157164, 157456, 157456, 157465, 157465, 157554, 157554, 157774, 161063, 161063, 161070, 161070, 161273, 161306, 161306, 161324, 161324, 161325, 161325, 161326, 161326, 162345, 162345, 162372, 162372, 162376, 162376, 162381, 162381, 162382, 162382, 162383, 162383, 162384, 162384, 162385, 162385, 162386, 162386, 162504, 162504, 162505, 162505, 163543, 163544, 163550, 163554, 163555, 163556, 163557, 164070, 164670, 164672, 164674, 164675, 164677, 164678, 164679, 164680, 164681, 164683, 164684, 164690, 164691, 164692, 164693, 164694, 164695, 164696, 164697, 164699, 164750, 164751, 164755, 164756, 164757, 164758, 164759, 164761, 164762, 164763, 164764, 164765, 164766, 164767, 164768, 164769, 164773, 164779, 164888, 164889, 166000, 166001, 166002, 166004, 166100, 166700, 166702, 166702, 166703, 166703, 166704, 166704, 166705, 166705, 166706, 166706, 166709, 166709, 166710, 166710, 166713, 166713, 166714, 166714, 166715, 166715, 166721, 166722, 166723, 166723, 166724, 166730, 166733, 166733, 166734, 166735, 166736, 166737, 166738, 166739, 166742, 166744, 166746, 166747, 166750, 166970, 169337, 169423, 169423, 169424, 169424, 169426, 169426, 169427, 169427, 169432, 169432, 169433, 169433, 169435, 169435, 169437, 169437, 169440, 169440, 169443, 169443, 169444, 169444, 169467, 169467, 169468, 169468, 169476, 169476, 169477, 169477, 169478, 169478, 169480, 169480, 169482, 169482, 169483, 169483, 169484, 169484, 169485, 169485, 169487, 169487, 169488, 169488, 169490, 169490, 169491, 169491, 169492, 169492, 169494, 169494, 169495, 169495, 169496, 169496, 169497, 169497, 169570, 169570, 169578, 169578, 169582, 169582, 169584, 169584, 169585, 169585, 169625, 169724, 169724, 169725, 169725, 169726, 169726, 169727, 169727, 169728, 169728, 169729, 169729, 169831, 169831, 169832, 169833, 184570, 184575, 184595, 184714, 184715, 184716, 612833, 612833, 612836, 612836, 612841, 612841, 612847, 612847, 618145, 618145, 618146, 618146, 618562, 618562, 618605, 618605, 618605, 618608, 618608, 618608, 618643, 618643, 618643, 618644, 618644, 618644, 618708, 618708, 618708, 618841, 618873, 619436, 619436, 619436, 619657, 619657, 619657, 619660, 619660, 619660, 619665, 619665, 619665, 619666, 619666, 619666, 623981, 623981, 623987, 623987, 623989, 623989, 623992, 623992, 623993, 623993, 623997, 623997, 623999, 623999, 624910, 624910, 624912, 624912, 624913, 624913, 624916, 624916, 624917, 624917, 624918, 624918, 624921, 624921, 624922, 624922, 624923, 624923, 624925, 624925, 624927, 624927, 624928, 624928, 626105, 626105, 626140, 626140, 626140, 626268, 626268, 628100, 628100, 628103, 628103, 628107, 628107, 628109, 628109, 628110, 628110, 628112, 628112, 628113, 628113, 628114, 628114, 628115, 628115, 628117, 628117, 628120, 628120, 628121, 628121, 628125, 628125, 628140, 628140, 628142, 628142, 628143, 628145, 628146, 628146, 628147, 628148, 628151, 628151, 628155, 628155, 628156, 628157, 628157, 628158, 628160, 628160, 628162, 628162, 628163, 628163, 628168, 628168, 628169, 628177, 628210, 628217, 628218, 628220, 628220, 628230, 628458, 628458, 628501, 628501, 628503, 628503, 628504, 628504, 628505, 628505, 628506, 628506, 628511, 628511, 628512, 628512, 628513, 628513, 628515, 628515, 628516, 628516, 628518, 628518, 628530, 628530, 628531, 628531, 628532, 628532, 628535, 628540, 628540, 628541, 628541, 628544, 628544, 628546, 628546, 628630, 628630, 628640, 628640, 628642, 628642, 628645, 628645, 628650, 628651, 628654, 628658, 629000, 629000, 629001, 629001, 629002, 629002, 629003, 629003, 629004, 629004, 629007, 629007, 629008, 629008, 629100, 629100, 629350, 629350, 629360, 629360, 629360, 629360, 629360, 629365, 629365, 629371, 629371, 629371, 629371, 629371, 629372, 629372, 629372, 629372, 629372, 629380, 629380, 629380, 629380, 629380, 629382, 629382, 629382, 629382, 629382, 629384, 629384, 629384, 629384, 629384, 629620, 629620, 629623, 629623, 629624, 629624, 629631, 629631, 629632, 629632, 629635, 629635, 629636, 629636, 629640, 629640, 629643, 629643, 629644, 629644, 629645, 629645, 629647, 629647, 629648, 629648, 629650, 629650, 629651, 629651, 629652, 629652, 629700, 629700, 629705, 629705, 629707, 629707, 629709, 629709, 629712, 629712, 629720, 629720, 629721, 629721, 629730, 629730, 629733, 629733, 629734, 629734, 629735, 629735, 629736, 629736, 629746, 629746, 629750, 629750, 629750, 629750, 629750, 629752, 629752, 629752, 629752, 629752, 629755, 629755, 629755, 629755, 629755, 629759, 629759, 629761, 629761, 629860, 629860, 629885, 629885, 629890, 629890, 629965, 629965, 636320, 636320, 636321, 636321, 636340, 636340, 636341, 636341, 636342, 636342, 636345, 636345, 636430, 636430, 636445, 636445, 636446, 636446, 636454, 636454, 636455, 636455, 636510, 636510, 636512, 636512, 636513, 636513, 636516, 636516, 636518, 636518, 636519, 636519, 636611, 636611, 636612, 636612, 636710, 636712, 636712, 636720, 636721, 636730, 636730, 636732, 636733, 636735, 636740, 636750, 636750, 636751, 636751, 636752, 636752, 636753, 636753, 636754, 636760, 636760, 636761, 636761, 636764, 636764, 636765, 636765, 636766, 636766, 636767, 636767, 646514, 646514, 646580, 646582, 646583, 646586, 646587, 646588, 646589, 646590, 646591, 646593, 646594, 646595, 646597, 646599, 647000, 647002, 647005, 647220, 647230, 647232, 647234, 647235, 647340, 647341, 647460, 647462, 647470, 647471, 647472, 647474, 647475, 647483, 647484, 647485, 647486, 647501, 647502, 647503, 647504, 647505, 647506, 648000, 648001, 648360, 648361, 648364, 648365, 648367, 648368, 648369, 648371, 648372, 648373, 648482, 648483, 648490, 648571, 648580, 648581, 648590, 648591, 648592, 648593, 648594, 652975, 663161, 663161, 663162, 663162, 663164, 663164, 663170, 663170, 663172, 663172, 663173, 663173, 663176, 663176, 663200, 663200, 663204, 663204, 663213, 663214, 663230, 663230, 663231, 663231, 663234, 663234, 663237, 663242, 663242, 663243, 663243, 663244, 663244, 663245, 663245, 663246, 663246, 663248, 663248, 663249, 663249, 663253, 663253, 663282, 663285, 663286, 663288, 663289, 663291, 663293, 663296, 663300, 663302, 663305, 663307, 663308, 663310, 663314, 663316, 663317, 663318, 663319, 663321, 663330, 663332, 663333, 663335, 663340, 663341, 663345, 663413, 663413, 663420, 663420, 663437, 663437, 663440, 663440, 663442, 663442, 663447, 663447, 663448, 663448, 663453, 663453, 663454, 663454, 663466, 663466, 663470, 663474, 663476, 663481, 663485, 663488, 665140, 665145, 665150, 665750, 665750, 665750, 665752, 665752, 665752, 665753, 665753, 665753, 665756, 665756, 665756, 665768, 665768, 665768, 665777, 665777, 665777, 665784, 665784, 665784, 665795, 665795, 665795, 665796, 665796, 665796, 666371, 666371, 666371, 666372, 666372, 666372, 666373, 666373, 666373, 666374, 666374, 666374, 666375, 666375, 666375, 666501, 666501, 666515, 666515, 666516, 666516, 666611, 666615, 666620, 666623, 666625, 666630, 666633, 666635, 666637, 666639, 666700, 666701, 666702, 666703, 666705, 666711, 666712, 666713, 666714, 666715, 666716, 666719, 666720, 666730, 666731, 666733, 666743, 666744, 666745, 666746, 666801, 666811, 666820, 666821, 666830, 666832, 666900, 666901, 666902, 666904, 666911, 666920, 666921, 666922, 666924, 666925, 666926, 666931, 666940, 666960, 671522, 671531, 671550, 673365, 673365, 676209, 676226, 676230, 676331, 676331, 676557, 676557, 676560, 676560, 676563, 676563, 676564, 676564, 676566, 676566, 676567, 676567, 676574, 676574, 676581, 676581, 677000, 677000, 677001, 677001, 677004, 677004, 677005, 677005, 677007, 677007, 677008, 677008, 677009, 677009, 677010, 677010, 677011, 677011, 677013, 677013, 677014, 677014, 677015, 677015, 677016, 677016, 677018, 677018, 677019, 677019, 677021, 677021, 677022, 677022, 677027, 677027, 677099, 677099, 677700, 677700, 677880, 677880, 677901, 677901, 677902, 677902, 677903, 677903, 677904, 677904, 677906, 677906, 677907, 677907, 677911, 677911, 677930, 677930, 677935, 677935, 677940, 677940, 677960, 677960, 677961, 677961, 677970, 677970, 677980, 677980, 677999, 677999, 678000, 678000, 678001, 678001, 678002, 678002, 678005, 678005, 678006, 678006, 678011, 678011, 678012, 678012, 678013, 678013, 678014, 678014, 678016, 678016, 678017, 678017, 678020, 678020, 678021, 678021, 678022, 678022, 678023, 678023, 678024, 678024, 678025, 678025, 678026, 678026, 678027, 678027, 678028, 678028, 678030, 678030, 678033, 678033, 678034, 678034, 678035, 678035, 678036, 678036, 678037, 678037, 678038, 678038, 678041, 678041, 678042, 678042, 678070, 678070, 678073, 678073, 678074, 678074, 678075, 678075, 678076, 678076, 678077, 678077, 678078, 678078, 678080, 678080, 678081, 678081, 678082, 678082, 678083, 678083, 678084, 678084, 678085, 678085, 678086, 678086, 678087, 678087, 678088, 678088, 678089, 678089, 678091, 678091, 678092, 678092, 678093, 678093, 678094, 678094, 678095, 678095, 678099, 678099, 678100, 678100, 678100, 678100, 678100, 678105, 678105, 678105, 678105, 678105, 678106, 678106, 678106, 678106, 678106, 678107, 678107, 678107, 678107, 678107, 678109, 678109, 678109, 678109, 678109, 678110, 678110, 678110, 678110, 678110, 678111, 678111, 678111, 678111, 678111, 678112, 678112, 678112, 678112, 678112, 678113, 678113, 678113, 678113, 678113, 678115, 678115, 678115, 678115, 678115, 678116, 678116, 678116, 678116, 678116, 678117, 678117, 678117, 678117, 678117, 678118, 678118, 678118, 678118, 678118, 678119, 678119, 678119, 678119, 678119, 678120, 678120, 678120, 678120, 678120, 678123, 678123, 678123, 678123, 678123, 678124, 678124, 678124, 678124, 678124, 678126, 678126, 678126, 678126, 678126, 678131, 678131, 678131, 678131, 678131, 678132, 678132, 678132, 678132, 678132, 678133, 678133, 678133, 678133, 678133, 678134, 678134, 678134, 678134, 678134, 678139, 678139, 678139, 678139, 678139, 678141, 678142, 678144, 678145, 678149, 678150, 678152, 678154, 678158, 678159, 678162, 678163, 678164, 678165, 678166, 678167, 678168, 678170, 678171, 678172, 678173, 678174, 678175, 678179, 678180, 678181, 678183, 678184, 678185, 678186, 678188, 678190, 678191, 678196, 678200, 678200, 678202, 678202, 678205, 678205, 678206, 678206, 678207, 678207, 678208, 678208, 678209, 678209, 678211, 678211, 678212, 678212, 678213, 678213, 678214, 678214, 678215, 678215, 678216, 678216, 678219, 678219, 678220, 678220, 678221, 678221, 678222, 678222, 678223, 678223, 678224, 678224, 678225, 678225, 678226, 678226, 678227, 678227, 678228, 678228, 678229, 678229, 678230, 678230, 678232, 678232, 678233, 678233, 678234, 678234, 678235, 678235, 678236, 678236, 678237, 678237, 678238, 678238, 678240, 678240, 678241, 678241, 678242, 678242, 678243, 678243, 678244, 678244, 678245, 678245, 678246, 678246, 678247, 678247, 678248, 678248, 678249, 678249, 678271, 678271, 678272, 678272, 678273, 678273, 678274, 678274, 678275, 678275, 678276, 678276, 678277, 678277, 678278, 678278, 678279, 678279, 678280, 678280, 678281, 678281, 678282, 678282, 678283, 678283, 678284, 678284, 678285, 678285, 678286, 678286, 678287, 678287, 678288, 678288, 678290, 678290, 678300, 678300, 678305, 678305, 678309, 678309, 678310, 678310, 678311, 678311, 678312, 678312, 678313, 678313, 678314, 678314, 678315, 678315, 678316, 678316, 678318, 678318, 678320, 678320, 678321, 678321, 678322, 678322, 678328, 678328, 678330, 678330, 678330, 678330, 678330, 678336, 678336, 678336, 678336, 678336, 678338, 678338, 678338, 678338, 678338, 678343, 678343, 678343, 678343, 678343, 678349, 678349, 678349, 678349, 678349, 678350, 678350, 678354, 678354, 678355, 678355, 678356, 678356, 678357, 678357, 678358, 678358, 678359, 678359, 678360, 678360, 678361, 678361, 678362, 678362, 678363, 678363, 678364, 678364, 678365, 678365, 678366, 678366, 678367, 678367, 678368, 678368, 678369, 678369, 678370, 678370, 678371, 678371, 678372, 678372, 678373, 678373, 678380, 678380, 678383, 678383, 678384, 678384, 678385, 678385, 678386, 678386, 678387, 678387, 678388, 678388, 678389, 678389, 678391, 678391, 678392, 678392, 678393, 678393, 678395, 678395, 678396, 678396, 678397, 678397, 678400, 678400, 678400, 678400, 678400, 678403, 678403, 678403, 678403, 678403, 678409, 678409, 678409, 678409, 678409, 678410, 678410, 678410, 678410, 678410, 678411, 678411, 678411, 678411, 678411, 678412, 678412, 678412, 678412, 678412, 678414, 678414, 678414, 678414, 678414, 678420, 678420, 678420, 678420, 678420, 678421, 678421, 678421, 678421, 678421, 678431, 678431, 678431, 678431, 678431, 678440, 678440, 678440, 678440, 678440, 678442, 678442, 678442, 678442, 678442, 678450, 678450, 678454, 678454, 678455, 678455, 678456, 678456, 678457, 678457, 678459, 678459, 678460, 678460, 678461, 678461, 678462, 678462, 678463, 678463, 678464, 678464, 678465, 678465, 678471, 678471, 678472, 678472, 678473, 678473, 678475, 678475, 678479, 678479, 678480, 678480, 678480, 678480, 678480, 678488, 678488, 678488, 678488, 678488, 678489, 678489, 678489, 678489, 678489, 678492, 678492, 678492, 678492, 678492, 678500, 678500, 678500, 678500, 678500, 678504, 678504, 678504, 678504, 678504, 678505, 678505, 678505, 678505, 678505, 678509, 678509, 678509, 678509, 678509, 678510, 678510, 678510, 678510, 678510, 678511, 678511, 678511, 678511, 678511, 678515, 678515, 678515, 678515, 678515, 678521, 678521, 678521, 678521, 678521, 678522, 678522, 678522, 678522, 678522, 678525, 678525, 678525, 678525, 678525, 678526, 678526, 678526, 678526, 678526, 678527, 678527, 678527, 678527, 678527, 678530, 678530, 678530, 678530, 678530, 678540, 678540, 678540, 678540, 678540, 678549, 678549, 678549, 678549, 678549, 678550, 678550, 678550, 678550, 678550, 678551, 678551, 678551, 678551, 678551, 678552, 678552, 678552, 678552, 678552, 678560, 678560, 678560, 678560, 678560, 678561, 678561, 678561, 678561, 678561, 678562, 678562, 678562, 678562, 678562, 678563, 678563, 678563, 678563, 678563, 678564, 678564, 678564, 678564, 678564, 678571, 678571, 678571, 678571, 678571, 678580, 678580, 678580, 678580, 678580, 678585, 678585, 678585, 678585, 678585, 678586, 678586, 678586, 678586, 678586, 678600, 678600, 678602, 678602, 678603, 678603, 678604, 678604, 678605, 678605, 678606, 678606, 678607, 678607, 678608, 678608, 678610, 678610, 678611, 678611, 678612, 678612, 678615, 678615, 678616, 678616, 678620, 678620, 678622, 678622, 678623, 678623, 678624, 678624, 678627, 678627, 678629, 678629, 678630, 678630, 678631, 678631, 678635, 678635, 678638, 678638, 678640, 678640, 678643, 678643, 678650, 678650, 678653, 678653, 678654, 678654, 678655, 678655, 678656, 678656, 678657, 678657, 678658, 678658, 678659, 678659, 678660, 678660, 678661, 678661, 678662, 678662, 678665, 678665, 678666, 678666, 678667, 678667, 678670, 678670, 678671, 678671, 678674, 678674, 678675, 678675, 678677, 678677, 678678, 678678, 678679, 678679, 678680, 678680, 678681, 678681, 678682, 678682, 678683, 678683, 678685, 678685, 678686, 678686, 678687, 678687, 678690, 678690, 678691, 678691, 678692, 678692, 678699, 678699, 678711, 678711, 678715, 678715, 678719, 678719, 678720, 678720, 678723, 678723, 678724, 678724, 678725, 678725, 678726, 678726, 678728, 678728, 678729, 678729, 678730, 678730, 678730, 678730, 678730, 678735, 678735, 678735, 678735, 678735, 678739, 678739, 678739, 678739, 678739, 678750, 678750, 678750, 678750, 678750, 678761, 678761, 678761, 678761, 678761, 678769, 678769, 678769, 678769, 678769, 678770, 678770, 678770, 678770, 678770, 678772, 678772, 678772, 678772, 678772, 678773, 678773, 678773, 678773, 678773, 678781, 678781, 678781, 678781, 678781, 678782, 678782, 678782, 678782, 678782, 678783, 678783, 678783, 678783, 678783, 678784, 678784, 678784, 678784, 678784, 678785, 678785, 678785, 678785, 678785, 678786, 678786, 678786, 678786, 678786, 678787, 678787, 678787, 678787, 678787, 678789, 678789, 678789, 678789, 678789, 678790, 678790, 678790, 678790, 678790, 678797, 678797, 678797, 678797, 678797, 678800, 678800, 678800, 678800, 678800, 678803, 678803, 678803, 678803, 678803, 678805, 678805, 678805, 678805, 678805, 678810, 678810, 678810, 678810, 678810, 678815, 678815, 678815, 678815, 678815, 678819, 678819, 678819, 678819, 678819, 678822, 678822, 678822, 678822, 678822, 678829, 678829, 678829, 678829, 678829, 678830, 678830, 678830, 678830, 678830, 678831, 678831, 678831, 678831, 678831, 678835, 678835, 678835, 678835, 678835, 678837, 678837, 678837, 678837, 678837, 678860, 678860, 678860, 678860, 678860, 678862, 678862, 678862, 678862, 678862, 678863, 678863, 678863, 678863, 678863, 678864, 678864, 678864, 678864, 678864, 678865, 678865, 678865, 678865, 678865, 678871, 678871, 678871, 678871, 678871, 678881, 678881, 678881, 678881, 678881, 678890, 678890, 678890, 678890, 678890, 678892, 678892, 678892, 678892, 678892, 678893, 678893, 678893, 678893, 678893, 678894, 678894, 678894, 678894, 678894, 678895, 678895, 678895, 678895, 678895, 678915, 678915, 678916, 678916, 678931, 678931, 680530, 680530, 680533, 680533, 682380, 682382, 682383, 682384, 682387, 682390, 682391, 682392, 682400, 682400, 682401, 682401, 682406, 682406, 682408, 682408, 682409, 682409, 682410, 682410, 682412, 682412, 682415, 682415, 682418, 682418, 682419, 682419, 682420, 682420, 682421, 682421, 682423, 682423, 682424, 682424, 682425, 682425, 682426, 682426, 682427, 682427, 682429, 682429, 682431, 682432, 682434, 682436, 682440, 682442, 682444, 682446, 682447, 682449, 682450, 682456, 682459, 682460, 682462, 682469, 682480, 682482, 682489, 682490, 682493, 682494, 682499, 682560, 682562, 682564, 682571, 682573, 682574, 682575, 684110, 684111, 684200, 684202, 684220, 684400, 684400, 684401, 684401, 684405, 684405, 684406, 684406, 684412, 684412, 684414, 684414, 684415, 684415, 684500, 685000, 685000, 685001, 685001, 685002, 685002, 685003, 685003, 685004, 685004, 685005, 685005, 685007, 685007, 685017, 685017, 685021, 685021, 685024, 685024, 685030, 685030, 685031, 685031, 685098, 685098, 685099, 685099, 685700, 685700, 685910, 685910, 685916, 685916, 685918, 685918, 685922, 685922, 685930, 685930, 685940, 685940, 685941, 685941, 685942, 685942, 685960, 685960, 685961, 685961, 686050, 686050, 686056, 686056, 686062, 686062, 686070, 686070, 686110, 686110, 686112, 686112, 686114, 686114, 686117, 686117, 686134, 686134, 686135, 686135, 686160, 686160, 686164, 686164, 686210, 686210, 686217, 686217, 686222, 686222, 686230, 686230, 686242, 686242, 686314, 686314, 686323, 686323, 686332, 686332, 686333, 686333, 686410, 686410, 686417, 686417, 686430, 686433, 686440, 686441, 686442, 688000, 688600, 688610, 688611, 688612, 688621, 688700, 688710, 688711, 688713, 688714, 688716, 688800, 688810, 688811, 688815, 688816, 688820, 688822, 688823, 688824, 688850, 688861, 688862, 688863, 688866, 688867, 688868, 688901, 688902, 689000, 689100, 689115, 689120, 689125, 689201, 689202, 689210, 689215, 689224, 689230, 689235, 689251, 689271, 689272, 689273, 689274, 689275, 689300, 689310, 689313, 689315, 689320, 689330, 689350, 689360, 689380, 689400, 689415, 689417, 689425, 689430, 689450, 689460, 689465, 689468, 689470, 689480, 689500, 689501, 689503, 689504, 689506, 689510, 689514, 689516, 689530, 689532, 689533, 689534, 689540, 689541, 689700, 692162, 692163, 692164, 692166, 692167, 692168, 692169]

  def self.description
    "Калькулятор доставки Почтой России"
  end

  def self.register
    super
    ShippingRate.register_calculator(self)
    ShippingMethod.register_calculator(self)
  end

  # По идее мы должны различать считаем мы для Shipment или для Order.
  # Но так как у нас всегда заказ отправляется одной посылкой, то
  # различения не делаем.
  # Формула:
  def compute(object)
    return unless object.present? and object.line_items.present?
    order = object.respond_to?(:order) ? object.order : object
    total_weight = Calculator::RussianPost.get_total_weight(order.line_items)
    delivery_zone = get_delivery_zone(order.ship_address.zipcode)
    return 0 if delivery_zone.nil? 
    stoimost_dostavki = get_stoimost_dostavki(delivery_zone, total_weight)
    stoimost_dostavki + get_strahovoy_sbor(order, stoimost_dostavki) + prosto_tak=13
  end

  # Предполагаем, что вес упаковки линейно зависит от веса посылки.
  # То есть ПолныйВес = А*ВесТоваров + B
  # Набирая статистику ПолногоВеса и ВесаТовара и использую метод наименьших квадратов
  # (онлайн-сервис тутhttp://www.chem-astu.ru/science/lsq/ )
  # Получаем коэффициенты А и B
  # А = 1.1; B = 42
  def self.get_total_weight (line_items)
    a = 1.1
    b = 42
    b + a*line_items.map { |li| li.quantity*(li.variant.weight.nil? ? VES_TOVARA_PO_UMOLCHANIYU : li.variant.weight)}.sum
  end

  private

  # Если индекс содержится в БД труднодоступных отделений - то не рассчитываем доставку.
  def get_delivery_zone (zipcode)
    TRUDNODOSTUPNIE_INDEXI.include?(zipcode.to_i) ? nil : INDEX_ZONE_HASH[zipcode.to_s[0,3]]
  end

  def get_stoimost_dostavki (zone, weight)
    extra_500g_price_count = (weight*2/1000).to_i
    get_ground_price(zone) + extra_500g_price_count*get_extra_500g_price(zone)
  end

  # Взято со страницы 13.04.2012
  # http://russianpost.ru/rp/servise/ru/home/postuslug/bookpostandparcel/parcelltariff
  def get_ground_price (zone)
    case zone
    when '1'
      130.90
    when '2'
      132.70
    when '3'
      138.1
    when '4'
      168.2
    when '5'
      189.50
    else
      nil
    end
  end

  def get_extra_500g_price (zone)
    case zone
    when '1'
      10.0
    when '2'
      11.6
    when '3'
      16.9
    when '4'
      24.3
    when '5'
      28.1
    else
      nil
    end
  end

  def get_strahovoy_sbor (order, stoimost_dostavki)
    (order.item_total + stoimost_dostavki) * STRAHOVOY_SBOR/100
  end

end 
